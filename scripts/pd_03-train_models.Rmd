---
title: 'England Peat Depth Model: Train models'
output:
  word_document: default
  html_notebook: default
---

#Peat Depths: run models

## Packages 
```{r, include=FALSE}
library(raster)
library(rgdal)

library(randomForest)
library(Rborist)
library(e1071)
library(kernlab)
library(mboost)
library(ranger)

library(caret)
library(parallel)
library(doParallel)

#data import
library(aws.s3)
library(aws.ec2metadata)
```

## Load data
```{r}
load(file = "../data/input.data.rds")
dim(input.data)
```

### create directory if necessary
```{r}
dir.create("../data/models")
```


## Start Parallel Processing
```{r}
detectCores()
getDoParWorkers()
cl <- makeCluster(detectCores()-1)
registerDoParallel(cl)
getDoParName()
getDoParWorkers()
#registerDoSEQ() # to stop parallel processing
```


## Make training and test sets

```{r}
set.seed(123)
inTrain <- createDataPartition(y = input.data$PEAT_DEPTH, 
                               p = .75, # The percentage of data in the training set
                               list = FALSE) # The format of the results

training <- input.data[inTrain,]
testing <- input.data[-inTrain,]
```
Training data has `r nrow(training)` records.  Testing data has `r nrow(testing)` records.  

#### train model
**Need the latest version of caret from github to avoid known bug.**

set model parameters
```{r}
params <- trainControl(method = "cv", number = 10)
```

set up system performance monitoring
```{r}
modeltime <- data.frame(model = as.character(), 
                        insType = as.character(),
                        time_mins = as.difftime(character()))
```



#### train linear model
```{r}
  starttime <- Sys.time()

Mlmuk1b <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "lm")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mlmuk1b",
                                insType = aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))

save(Mlmuk1b, file = "../data/models/Mlmuk1b.rds")

Mlmuk1b
```

#### train random forest model
```{r}

  starttime <- Sys.time()

Mrfuk1b <- train(PEAT_DEPTH ~ .,
              data = training,
              method = "ranger", 
              num.trees = 100)
              
  modeltime <- rbind(
    modeltime, 
    data.frame(model = "Mrfuk1b",
               insType = aws.ec2metadata::metadata$instance_type(),
               time_mins = difftime(Sys.time(), starttime, 
                                    units = "mins")))  

save(Mrfuk1b, file = "../data/models/Mrfuk1b.rds")

Mrfuk1b
```

performance stats
```{r}
rbind(getTrainPerf(Mlmuk1b), getTrainPerf(Mrfuk1b))
```

####train generalised linear model
```{r}
  starttime <- Sys.time()

Mglmuk1b <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "glm")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mglmuk1b",
                                insType = aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
save(Mglmuk1b, file = "../data/models/Mglmuk1b.rds")

Mglmuk1b
```

####train boosted generalised linear model
```{r}
  starttime <- Sys.time()

Mbglmuk1b <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "glmboost")


  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mbglmuk1b",
                                insType = aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
save(Mbglmuk1b, file = "../data/models/Mbglmuk1b.rds")

Mbglmuk1b
```

####train k nearest neighbours model
```{r}
  starttime <- Sys.time()

Mknnuk1b <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "knn")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mknnuk1b",
                                insType = aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Mknnuk1b, file = "../data/models/Mknnuk1b.rds")

Mknnuk1b
```


####train Generalised Additive Model 

```{r}
  starttime <- Sys.time()

Mgamuk1b <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "gam")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mgamuk1b",
                                insType = aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Mgamuk1b, file = "../data/models/Mgamuk1b.rds")

Mgamuk1b
```

####train Gradient Boosting Model 
```{r}
  starttime <- Sys.time()

Mgbmuk1b <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "gbm")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mgbmuk1b",
                                insType = aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Mgbmuk1b, file = "../data/models/Mgbmuk1b.rds")

Mgbmuk1b
```

####train support vector machine (SVM)
```{r}
#standardise training data first
#preproc_stand <- preProcess(training, method = c("center", "scale"))
#training_stand <- predict(preproc_stand, training); summary(training_stand)
  starttime <- Sys.time()

Msvmuk1b <- train(PEAT_DEPTH ~ ., 
                data = training, 
                method = "svmLinear", # Linear Kernel
                preProc = c("center", "scale")) #standardise data

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Msvmuk1b",
                                insType = aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Msvmuk1b, file = "../data/models/Msvmuk1b.rds")

Msvmuk1b
```


## Evaluate models
```{r}
#load models
load("../data/models/Mlmuk1b.rds")
load("../data/models/Mrfuk1b.rds")
load("../data/models/Mglmuk1b.rds")
load("../data/models/Mbglmuk1b.rds")
load("../data/models/Mknnuk1b.rds")
load("../data/models/Mgamuk1b.rds")
load("../data/models/Mgbmuk1b.rds")
load("../data/models/Msvmuk1b.rds")
```

```{r}
cvValues <- resamples(list(LM = Mlmuk1b, 
                           RF = Mrfuk1b, 
                           GLM = Mglmuk1b, 
                           GLMB = Mbglmuk1b, 
                           KNN = Mknnuk1b,
                           GAM = Mgamuk1b, 
                           GBM = Mgbmuk1b, 
                           SVM = Msvmuk1b))
summary(cvValues)

#prep tabular summary of mean metrics
cvMeans <- data.frame(lapply(X = cvValues$values[-1], mean))
names(cvMeans) <- rep(cvValues$models, length(cvValues$metrics))
cvIndex <- seq(from = 1,
               by = length(cvValues$metrics),
               length.out = length(cvValues$models))

cvSummary <- data.frame(t(rbind(MAE = cvMeans[1,cvIndex], 
      RMSE = cvMeans[1, cvIndex + 1],
      RSq = cvMeans[1, cvIndex + 2])), 
      methods = cvValues$methods)
cvSummary

#plot outputs
splom(cvValues, metric = "Rsquared")
parallelplot(cvValues, metric = "Rsquared")
dotplot(cvValues, metric = "Rsquared")
```

```{r}
Diffs <- diff(cvValues, metric = "Rsquared")
summary(Diffs)
dotplot(Diffs, metric = "Rsquared")
```

## predict test data from model and evaluate

```{r}
#transform testing data

preproc_stand <- preProcess(testing, method = c("center", "scale"))
testing_stand <- predict(preproc_stand, testing)
```


```{r}
lm_pred <- predict(Mlmuk1b, testing)

rf_pred <- predict(Mrfuk1b, testing)

glm_pred <- predict(Mglmuk1b, testing)

glmb_pred <- predict(Mbglmuk1b, testing) 

knn_pred <- predict(Mknnuk1b, testing)

gam_pred <- predict(Mgamuk1b, testing)

gbm_pred <- predict(Mgbmuk1b, testing)

svm_pred <- predict(Msvmuk1b, testing)

```

Calculate deviation

**RMSE**: Root Mean Square Error. Standard deviation of the differences between predicted and observed values.  Measures accuracy.  Scale-dependent, so can't compare different datasets.  Sensitive to outliers. Smaller is better.  Calculated by   `sqrt(mean((pred - obs)^2` 

**Rsquared**: Coefficient of determination.  The proportion of the variation in the observed variable that is predictable from the predicted variable.  Not scale dependent.  Closer to 1 is better. Calculated by `R^2 = 1-\frac{∑ (y_i - \hat{y}_i)^2}{∑ (y_i - \bar{y}_i)^2}`

**MAE**: Mean Absolute Error.  The average of the difference between the absolute predicted and observed values.  Scale-dependent, so can't compare different datasets.  Sensitive to outliers. Smaller is better.  Calculated by `mean(abs(pred - obs))`


```{r}
mod_variance <- data.frame(rbind(
  postResample(pred = lm_pred, obs = testing$PEAT_DEPTH),
  postResample(pred = rf_pred, obs = testing$PEAT_DEPTH),
  postResample(pred = glm_pred, obs = testing$PEAT_DEPTH),
  postResample(pred = glmb_pred, obs = testing$PEAT_DEPTH),
  postResample(pred = knn_pred, obs = testing$PEAT_DEPTH),
  postResample(pred = gam_pred, obs = testing$PEAT_DEPTH),
  postResample(pred = gbm_pred, obs = testing$PEAT_DEPTH),
  postResample(pred = svm_pred, obs = testing$PEAT_DEPTH)
))

mod_variance <- cbind(model = c("lm", "rf", "glm", "glmb", "knn",
                                "gam", "gbm", "svm"), 
                      mod_variance)
mod_variance
```




## Train full models

####train full LM
```{r}
  starttime <- Sys.time()

Mlmuk1b.full <- train(PEAT_DEPTH ~ ., 
              data = input.data, 
              method = "lm")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mlmuk1b.full",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Mlmuk1b.full, file = "../data/models/Mlmuk1b.full.rds")

Mlmuk1b.full
```

####train full RF
```{r}
  starttime <- Sys.time()

Mrfuk1b.full <- train(PEAT_DEPTH ~ ., 
              data = input.data, 
              method = "Rborist")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mrfuk1b.full",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Mrfuk1b.full, file = "../data/models/Mrfuk1b.full.rds")

Mrfuk1b.full
```

####train full GAM
```{r}
  starttime <- Sys.time()

Mgamuk1b.full <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "gam")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mgamuk1b.full",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), 
                                                     starttime, 
                                                     units = "mins")))
  
save(Mgamuk1b.full, file = "../data/models/Mgamuk1b.full.rds")

Mgamuk1b.full 
```

####train full GBM 
```{r}
  starttime <- Sys.time()

Mgbmuk1b.full <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "gbm")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mgbmuk1b.full",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Mgbmuk1b.full, file = "../data/models/Mgbmuk1b.full.rds")

Mgbmuk1b.full
```


####train full KNN 
```{r}
  starttime <- Sys.time()

Mknnuk1b.full <- train(PEAT_DEPTH ~ ., 
              data = training, 
              method = "knn")

  modeltime <- rbind(modeltime, 
                     data.frame(model = "Mknnuk1b.full",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
  
save(Mknnuk1b.full, file = "../data/models/Mknnuk1b.full.rds")

Mknnuk1b.full
```


### evaluate
```{r}
rbind(getTrainPerf(Mlmuk1b.full), getTrainPerf(Mrfuk1b.full), getTrainPerf(Mgamuk1b.full), getTrainPerf(Mgbmuk1b.full), getTrainPerf(Mknnuk1b.full))
```

###export system performance stats: 
```{r}
dir.create("../outputs")
write.csv(x = modeltime, file = as.character(paste0("../outputs/modeltime", "_", format(Sys.time(), "%Y%m%d_%H%M"), ".csv")), row.names = FALSE)
```



## Export data

### Set credentials for S3 export
```{r}
#list IAM roles in instance
metadata$iam_role_names()

#get specified rolename (if only 1 leave at 1)
cred.role <- metadata$iam_role_names()[1]

#this works if running R from within an EC2 instance
Sys.setenv("AWS_ACCESS_KEY_ID" = metadata$iam_role(role = cred.role)$AccessKeyId,
           "AWS_SECRET_ACCESS_KEY" = metadata$iam_role(role = cred.role)$SecretAccessKey,
           "AWS_DEFAULT_REGION" = "eu-west-2",
           "AWS_SESSION_TOKEN" = metadata$iam_role(role = cred.role)$Token)
```

### Export data in terminal
```{bash}
#instance needs to have awscli installed: sudo apt-get install awscli
#(prob need to ssh into it as rstudio user doesn't have sudo access)
pwd

aws s3 ls
#copy entire folder
aws s3 sync /home/rstudio/enPeatDepthModel/data/models s3://ne-stats-data/enPeatDepthModel/data/models 

#copy file
aws s3 sync /home/rstudio/enPeatDepthModel/outputs s3://ne-stats-data/enPeatDepthModel/outputs 

#copy to local 
#aws s3 sync /home/rstudio/enPeatDepthModel/outputs c://Christoph/enPeatDepthModel/outputs
#not getting this to work
```
