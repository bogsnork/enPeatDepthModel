---
title: 'England Blanket Bog Model: predict from model'
output:
  html_notebook: default
---

## Packages 
```{r}
library(raster)
library(rgdal)
library(ranger)

library(parallel)
library(doParallel)

#data import
library(aws.s3)
library(aws.ec2metadata)
```

## Import data

### Set credentials for S3 import
```{r}
#list IAM roles in instance
metadata$iam_role_names()

#get specified rolename (if only 1 leave at 1)
cred.role <- metadata$iam_role_names()[1]

#this works if running R from within an EC2 instance
Sys.setenv("AWS_ACCESS_KEY_ID" = metadata$iam_role(role = cred.role)$AccessKeyId,
           "AWS_SECRET_ACCESS_KEY" = metadata$iam_role(role = cred.role)$SecretAccessKey,
           "AWS_DEFAULT_REGION" = "eu-west-2",
           "AWS_SESSION_TOKEN" = metadata$iam_role(role = cred.role)$Token)
```


### Import models in terminal
```{bash}
#instance needs to have awscli installed: sudo apt-get install awscli
#(prob need to ssh into it as rstudio user doesn't have sudo access)
pwd
aws s3 ls
#copy entire folder
aws s3 sync s3://ne-stats-data/enPeatDepthModel/data/models /home/rstudio/enPeatDepthModel/data/models

##and all the other data
aws s3 sync s3://ne-stats-data/enPeatDepthModel/data /home/rstudio/enPeatDepthModel/data
```



## Load data
```{r}
#load models
load("../data/models/Mlmuk1b.full.rds")
load("../data/models/Mrfuk1b.full.rds")
#load("../data/models/Mglmuk1b.full.rds")
#load("../data/models/Mbglmuk1b.full.rds")
load("../data/models/Mknnuk1b.full.rds")
load("../data/models/Mgamuk1b.full.rds")
load("../data/models/Mgbmuk1b.full.rds")
#load("../data/models/Msvmuk1b.full.rds")

#Model <- Mgbmuk1b.full 
#Model$coefnames
```

### Import predictors

```{r}
#load("../data/predictor_stack.Rdata")
plot(predictors)
```


```{r}
#import predictor stack
elev <- raster("../data/predictor_stack.tif", band = 1)
aspect <- raster("../data/predictor_stack.tif", band = 2)
slope <- raster("../data/predictor_stack.tif", band = 3)
gdd <- raster("../data/predictor_stack.tif", band = 4)
gsl <- raster("../data/predictor_stack.tif", band = 5)
rain_ann <- raster("../data/predictor_stack.tif", band = 6)
rain_daily <- raster("../data/predictor_stack.tif", band = 7)
raindays_10mm <- raster("../data/predictor_stack.tif", band = 8)
raindays_1mm <- raster("../data/predictor_stack.tif", band = 9)
temp_mean <- raster("../data/predictor_stack.tif", band = 10)
temp_min <- raster("../data/predictor_stack.tif", band = 11)
temp_max <- raster("../data/predictor_stack.tif", band = 12)

predictors <- stack(elev, aspect, slope, 
                    #outflow, inflow, 
                    gdd, gsl, rain_ann, rain_daily, 
                    raindays_10mm, raindays_1mm, temp_mean, temp_min, temp_max)

names(predictors) <-names(predictors) <- c("elev", "aspect", "slope", 
                                           #"outflow", "inflow",
                                           "gdd", "gsl", "rain_ann", "rain_daily", 
                                           "raindays_10mm", "raindays_1mm", "temp_mean", 
                                           "temp_min", "temp_max")
```

if necessary crop to prediction extent
```{r}
#crop to moorland line

#load moorland line
moorlineSPDF <- readOGR(dsn = "../data/moorland_line_RPA.shp", verbose = TRUE)
# boundbox <- observations@bbox; boundbox 
# 
# predictors <- raster::crop(x = predictors, y = boundbox)
# boundbox <- observations@bbox; boundbox

predictors <- raster::mask(x = predictors, mask = moorlineSPDF)

writeRaster(x = predictors, filename = "../data/predictors_moorline.tif")
# 

plot(predictors$elev)
```

```{r}
plot(predictors$elev)
```

## Start Parallel Processing
```{r}
detectCores()
getDoParWorkers()
cl <- makeCluster(detectCores()-1)
registerDoParallel(cl)
getDoParName()
getDoParWorkers()
#registerDoSEQ() # to stop parallel processing
```

## Predict outputs from predictors

```{r}

#  starttime <- Sys.time()
# 
# output <- raster::predict(predictors, Model)
# 
#   modeltime <- rbind(modeltime, 
#                      data.frame(model = "pd_gbm_moduk1b.tif",
#                                 insType = #if not on EC2, use local
#                                   "local",
#                                   #aws.ec2metadata::metadata$instance_type(),
#                                 time_mins = difftime(Sys.time(), starttime, units = "mins")))
#   
# 
# writeRaster(x = output, filename = "../outputs/pd_gbm_moduk1b.tif", overwrite = TRUE)
# 
# saveRDS(output, "../outputs/pd_gbm_moduk1b.rds")
# 
# plot(output)

```


## Predict a number of models

###linear model
```{r}
  starttime <- Sys.time()
pd_lm_uk1b <- raster::predict(predictors, Mlmuk1b.full, type="raw", progress="text",
                          response = "vote", index = 2)
  modeltime <- rbind(modeltime,
                     data.frame(model = "pd_lm_uk1b_ml.tif",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
writeRaster(x = pd_lm_uk1b, filename = "../outputs/pd_lm_uk1b_ml.tif")
#plot(pd_lm_uk1b)
```


###random forest model
```{r}
starttime <- Sys.time()
pd_rf_uk1b <- raster::predict(predictors, Mrfuk1b.full, type="raw", progress="text",
                          response = "vote", index = 2)
  modeltime <- rbind(modeltime,
                     data.frame(model = "pd_rf_uk1b_ml.tif",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
writeRaster(x = pd_rf_uk1b, filename = "../outputs/pd_rf_uk1b_ml.tif")
#plot(pd_rf_uk1b)
```

###GAM 
```{r}
  starttime <- Sys.time()
pd_gam_uk1b <- raster::predict(predictors, Mgamuk1b.full, type="raw", progress="text",
                          response = "vote", index = 2)
  modeltime <- rbind(modeltime,
                     data.frame(model = "pd_gam_uk1b_ml.tif",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
writeRaster(x = pd_gam_uk1b, filename = "../outputs/pd_gam_uk1b_ml.tif")
#plot(pd_gam_uk1b)
```

###GBM
```{r}
  starttime <- Sys.time()
pd_gbm_uk1b <- raster::predict(predictors, Mgbmuk1b.full, type="raw", progress="text",
                          response = "vote", index = 2)
  modeltime <- rbind(modeltime,
                     data.frame(model = "pd_gbm_uk1b_ml.tif",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
writeRaster(x = pd_gbm_uk1b, filename = "../outputs/pd_gbm_uk1b_ml.tif")
#plot(pd_gbm_uk1b)
```



###KNN model
```{r}
starttime <- Sys.time()
pd_knn_uk1b <- raster::predict(predictors, Mknnuk1b.full, type="raw", progress="text",
                          response = "vote", index = 2)
  modeltime <- rbind(modeltime,
                     data.frame(model = "pd_knn_uk1b_ml.tif",
                                insType = #if not on EC2, use local
                                  "local",
                                  #aws.ec2metadata::metadata$instance_type(),
                                time_mins = difftime(Sys.time(), starttime, units = "mins")))
writeRaster(x = pd_knn_uk1b, filename = "../outputs/pd_knn_uk1b_ml.tif")
#plot(pd_knn_uk1b)
```


###export system performance stats: 
```{r}
dir.create("../outputs")
write.csv(x = modeltime, file = as.character(paste0("../outputs/modeltime", "_", format(Sys.time(), "%Y%m%d_%H%M"), ".csv")), row.names = FALSE)
```



## Export data

### Set credentials for S3 export
```{r}
#list IAM roles in instance
metadata$iam_role_names()

#get specified rolename (if only 1 leave at 1)
cred.role <- metadata$iam_role_names()[1]

#this works if running R from within an EC2 instance
Sys.setenv("AWS_ACCESS_KEY_ID" = metadata$iam_role(role = cred.role)$AccessKeyId,
           "AWS_SECRET_ACCESS_KEY" = metadata$iam_role(role = cred.role)$SecretAccessKey,
           "AWS_DEFAULT_REGION" = "eu-west-2",
           "AWS_SESSION_TOKEN" = metadata$iam_role(role = cred.role)$Token)
```

### Export data in terminal
```{bash}
#instance needs to have awscli installed: sudo apt-get install awscli
#(prob need to ssh into it as rstudio user doesn't have sudo access)
pwd

aws s3 ls
#copy entire folder
aws s3 sync /home/rstudio/enPeatDepthModel/data/models s3://ne-stats-data/enPeatDepthModel/data/models 


#copy entire folder
aws s3 sync /home/rstudio/enPeatDepthModel/data s3://ne-stats-data/enPeatDepthModel/data 


#copy file
aws s3 sync /home/rstudio/enPeatDepthModel/outputs s3://ne-stats-data/enPeatDepthModel/outputs 

#copy to local 
#aws s3 sync /home/rstudio/enPeatDepthModel/outputs c://Christoph/enPeatDepthModel/outputs
#not getting this to work
```

